<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pages Search</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lunr.js (latest stable version) -->
    <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script>
    <style>
        /* Custom styles for aesthetic appeal */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: #f7f7fa;
        }
    </style>
</head>
<body class="p-4 sm:p-8 bg-gray-50">

    <div class="max-w-3xl mx-auto">
        
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Project Search Engine</h1>
            <p class="text-gray-600">Client-side search powered by a scheduled Python crawler and Lunr.js.</p>
        </header>

        <!-- Search Input -->
        <div class="mb-8 relative">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Start typing to search your documentation or site..." 
                class="w-full p-4 border border-gray-300 rounded-xl shadow-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-lg"
            >
            <div id="loading-indicator" class="absolute inset-y-0 right-0 pr-4 flex items-center hidden">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>

        <!-- Search Results -->
        <div id="search-results-container" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <p id="status-message" class="text-gray-500 italic">Start searching once the index loads.</p>
            <ul id="search-results" class="space-y-6">
                <!-- Results will be injected here -->
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const statusMessage = document.getElementById('status-message');
            const resultsList = document.getElementById('search-results');
            const loadingIndicator = document.getElementById('loading-indicator');
            let lunrIndex = null;
            let dataStore = {};

            /**
             * Initializes the Lunr index by fetching the generated index.json file.
             */
            async function initializeSearch() {
                loadingIndicator.classList.remove('hidden');
                statusMessage.textContent = 'Loading search index...';
                
                try {
                    // Fetch the index file generated by the crawler
                    const response = await fetch('/index.json');
                    if (!response.ok) {
                        throw new Error(`Failed to fetch index.json: ${response.statusText}`);
                    }
                    const data = await response.json();

                    // Build the Lunr Index
                    lunrIndex = lunr(function () {
                        // 'id' is used as the document reference (the full URL)
                        this.ref('id'); 
                        
                        // 'title' is boosted for relevance
                        this.field('title', { boost: 10 }); 
                        
                        // 'content' (the full page text) is the primary searchable field
                        this.field('content');
                        
                        // 'snippet' is searchable but with low boost, as it often duplicates content/title
                        this.field('snippet', { boost: 2 }); 

                        data.forEach(doc => this.add(doc));
                    });

                    // Store the raw data for displaying results (lookup by 'id')
                    dataStore = data.reduce((acc, doc) => {
                        acc[doc.id] = doc;
                        return acc;
                    }, {});

                    statusMessage.textContent = 'Index loaded successfully. Start searching!';
                    console.log(`[Search] Index loaded. ${data.length} documents available.`);

                } catch (error) {
                    statusMessage.textContent = 'Error loading index. Please check console.';
                    console.error('[Search Error]', error);
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            }

            /**
             * Handles the search logic when the user types.
             */
            function handleSearch() {
                const query = searchInput.value.trim();
                resultsList.innerHTML = '';
                
                if (!lunrIndex) {
                    statusMessage.textContent = 'Index not ready. Please wait or refresh.';
                    return;
                }

                if (query.length < 3) {
                    statusMessage.textContent = 'Keep typing to search...';
                    return;
                }

                statusMessage.textContent = `Searching for: "${query}"...`;
                loadingIndicator.classList.remove('hidden');

                // Perform the search
                // Use Lunr query syntax for better matching (e.g., prefix matching)
                const results = lunrIndex.search(`*${query}* ${query}*`);

                loadingIndicator.classList.add('hidden');

                if (results.length === 0) {
                    statusMessage.textContent = `No results found for "${query}".`;
                    return;
                }

                statusMessage.textContent = `${results.length} result(s) found.`;

                results.forEach(result => {
                    const item = dataStore[result.ref];
                    if (item) {
                        const li = document.createElement('li');
                        li.className = 'border-b border-gray-100 last:border-b-0 py-4';
                        
                        // Extract URL path for display (removes the full domain part)
                        const displayUrl = item.url.replace(/https?:\/\/[^\/]+/i, '');
                        
                        li.innerHTML = `
                            <a href="${item.url}" class="group block">
                                <h3 class="text-xl font-semibold text-blue-700 group-hover:text-blue-900 transition-colors">
                                    ${item.title}
                                </h3>
                                <p class="text-sm text-gray-500 mb-2">${displayUrl}</p>
                                <p class="text-gray-700">${item.snippet}</p>
                            </a>
                        `;
                        resultsList.appendChild(li);
                    }
                });
            }

            // Simple debounce function to prevent excessive calls while typing
            let debounceTimer;
            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(handleSearch, 200);
            });

            // Start the initialization process
            initializeSearch();
        });
    </script>
</body>
</html>
