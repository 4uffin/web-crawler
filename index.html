<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pages Search</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lunr.js (latest stable version) -->
    <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script>
    <style>
        /* Custom styles for aesthetic appeal */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: #f7f7fa;
        }
    </style>
</head>
<body class="p-4 sm:p-8 bg-gray-50">

    <div class="max-w-3xl mx-auto">
        
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Project Search Engine</h1>
            <p class="text-gray-600">Client-side search powered by a scheduled Python crawler and Lunr.js.</p>
        </header>

        <!-- Search Input -->
        <div class="mb-8 relative">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Start typing to search your documentation or site..." 
                class="w-full p-4 border border-gray-300 rounded-xl shadow-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-lg"
                autofocus
            >
            <div id="loading-indicator" class="absolute right-4 top-1/2 -translate-y-1/2 hidden">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>

        <!-- Search Results -->
        <div id="status-message" class="text-gray-600 italic mb-4">Initializing search...</div>
        <ul id="results-list" class="bg-white rounded-xl shadow-xl divide-y divide-gray-100">
            <!-- Search results will be inserted here -->
        </ul>
        
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const resultsList = document.getElementById('results-list');
            const statusMessage = document.getElementById('status-message');
            const loadingIndicator = document.getElementById('loading-indicator');

            let idx;      // Lunr index instance
            let store = {}; // Data store (Map from ID to document)

            const INDEX_FILE = "index.json";

            /**
             * Initializes the Lunr index by fetching the JSON data.
             */
            async function initializeSearch() {
                try {
                    loadingIndicator.classList.remove('hidden');
                    statusMessage.textContent = "Fetching site index...";
                    
                    const response = await fetch(INDEX_FILE);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const documents = await response.json();
                    
                    statusMessage.textContent = "Building search index...";

                    // Build the Lunr index
                    idx = lunr(function () {
                        // The reference field, unique identifier for each document
                        this.ref('id'); 
                        
                        // Fields to search over. Weights prioritize certain fields.
                        this.field('title', { boost: 10 });
                        this.field('content', { boost: 1 });
                        this.field('url');
                        
                        // Add each document to the index
                        documents.forEach(doc => {
                            // Store the full document data (title, url, snippet) separately
                            store[doc.id] = doc; 
                            this.add(doc);
                        });
                    });

                    statusMessage.textContent = `Index ready! (${documents.length} pages indexed).`;
                    searchInput.disabled = false;
                    searchInput.focus();

                } catch (error) {
                    statusMessage.textContent = `Error loading or building index: ${error.message}. Please ensure ${INDEX_FILE} exists and is valid JSON.`;
                    console.error("Search Initialization Error:", error);
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            }

            /**
             * Performs the search based on the input query.
             */
            function handleSearch() {
                const query = searchInput.value.trim();
                resultsList.innerHTML = '';
                
                if (!idx) {
                    statusMessage.textContent = "Search index is not ready yet.";
                    return;
                }
                
                if (query.length === 0) {
                    statusMessage.textContent = `Index ready! (${Object.keys(store).length} pages indexed).`;
                    return;
                }

                // Show loading indicator briefly while searching
                loadingIndicator.classList.remove('hidden');
                
                // Perform the search using Lunr's search method
                const results = idx.search(query); 
                
                loadingIndicator.classList.add('hidden');

                if (results.length === 0) {
                    statusMessage.textContent = `No results found for "${query}"`;
                } else {
                    statusMessage.textContent = `${results.length} result(s) found for "${query}"`;
                    
                    results.forEach(result => {
                        const item = store[result.ref];
                        if (item) {
                            const li = document.createElement('li');
                            li.className = 'border-b border-gray-100 last:border-b-0 py-4 px-6 hover:bg-gray-50 transition-colors rounded-xl';
                            
                            // Extract URL path for display (removes the full domain part)
                            const displayUrl = item.url.replace(/https?:\/\/[^\/]+/i, '');
                            
                            li.innerHTML = `
                                <a href="${item.url}" class="group block">
                                    <h3 class="text-xl font-semibold text-blue-700 group-hover:text-blue-900 transition-colors">
                                        ${item.title}
                                    </h3>
                                    <p class="text-sm text-gray-500 mb-2 truncate">${displayUrl || '/'}</p>
                                    <p class="text-gray-700 text-sm">${item.snippet}</p>
                                </a>
                            `;
                            resultsList.appendChild(li);
                        }
                    });
                }
            }

            // Simple debounce function to prevent excessive calls while typing
            let debounceTimer;
            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(handleSearch, 200);
            });

            // Start the initialization process
            initializeSearch();
        });
    </script>
</body>
</html>
